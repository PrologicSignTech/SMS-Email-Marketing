@{
    ViewData["Title"] = "Assign Phone Numbers";
    Layout = "_LayoutAuthenticated";
    var assignRoles = User.FindAll(System.Security.Claims.ClaimTypes.Role).Select(c => c.Value).ToList();
    var isAdminOrSuper = assignRoles.Contains("Admin") || assignRoles.Contains("SuperAdmin");
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="bi bi-person-badge"></i> Assign Phone Numbers</h2>
            <p class="text-muted mb-0">Assign available numbers to users or unassign them</p>
        </div>
        <a href="@Url.Action("Index")" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Back</a>
    </div>

    <div class="row">
        <!-- Available Numbers -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-telephone-plus text-success me-2"></i>Available Numbers</h5>
                    <span class="badge bg-success" id="availableCount">0</span>
                </div>
                <div class="card-body p-0">
                    <div id="availableLoading" class="text-center py-4"><div class="spinner-border text-primary"></div></div>
                    <div id="availableList" style="max-height:500px;overflow-y:auto"></div>
                </div>
            </div>
        </div>

        <!-- Assigned Numbers -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-person-check text-primary me-2"></i>Assigned Numbers</h5>
                    <span class="badge bg-primary" id="assignedCount">0</span>
                </div>
                <div class="card-body p-0">
                    <div id="assignedLoading" class="text-center py-4"><div class="spinner-border text-primary"></div></div>
                    <div id="assignedList" style="max-height:500px;overflow-y:auto"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Assign Modal -->
<div class="modal fade" id="assignModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header"><h5 class="modal-title">Assign Number</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
                <input type="hidden" id="assignNumberId">
                <p>Assign <strong id="assignNumberDisplay"></strong> to:</p>
                <select class="form-select" id="assignUserId">
                    <option value="">Loading users...</option>
                </select>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmAssign()"><i class="bi bi-check-circle"></i> Assign</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script nonce="@Context.GetCspNonce()">
        var canAssign = @(isAdminOrSuper ? "true" : "false");
        var capNames = ['SMS', 'MMS', 'Both'];
        var typeNames = ['Local', 'Toll-Free', 'Short Code', 'Mobile'];

        document.addEventListener('DOMContentLoaded', function() {
            loadAvailable();
            loadAssigned();
            loadUsers();
        });

        function loadAvailable() {
            fetch('/PhoneNumbers/GetAvailableNumbers')
                .then(r => r.json())
                .then(result => {
                    var numbers = Array.isArray(result.data) ? result.data : [];
                    document.getElementById('availableCount').textContent = numbers.length;
                    document.getElementById('availableLoading').style.display = 'none';
                    var list = document.getElementById('availableList');

                    if (numbers.length === 0) {
                        list.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-telephone-x" style="font-size:2rem"></i><p class="mt-2">No available numbers</p></div>';
                        return;
                    }

                    list.innerHTML = '<div class="list-group list-group-flush">' + numbers.map(n =>
                        '<div class="list-group-item d-flex justify-content-between align-items-center">' +
                        '<div><strong>' + n.number + '</strong>' +
                        (n.friendlyName ? ' <span class="text-muted">(' + n.friendlyName + ')</span>' : '') +
                        '<br><span class="badge bg-secondary me-1">' + (typeNames[n.numberType] || 'Local') + '</span>' +
                        '<span class="badge bg-info">' + (capNames[n.capabilities] || 'SMS') + '</span></div>' +
                        (canAssign ? '<button class="btn btn-sm btn-success" onclick="showAssignModal(' + n.id + ',\'' + n.number + '\')"><i class="bi bi-person-plus"></i> Assign</button>' : '') +
                        '</div>'
                    ).join('') + '</div>';
                })
                .catch(() => { document.getElementById('availableLoading').innerHTML = '<p class="text-danger">Failed to load</p>'; });
        }

        function loadAssigned() {
            fetch('/PhoneNumbers/GetPhoneNumbers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ draw: 1, start: 0, length: 100, search: { value: '' } })
            })
            .then(r => r.json())
            .then(result => {
                var allNumbers = Array.isArray(result.data) ? result.data : [];
                var assigned = allNumbers.filter(n => n.assignedToUserId && n.status === 1);
                document.getElementById('assignedCount').textContent = assigned.length;
                document.getElementById('assignedLoading').style.display = 'none';
                var list = document.getElementById('assignedList');

                if (assigned.length === 0) {
                    list.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-person-x" style="font-size:2rem"></i><p class="mt-2">No assigned numbers</p></div>';
                    return;
                }

                list.innerHTML = '<div class="list-group list-group-flush">' + assigned.map(n =>
                    '<div class="list-group-item d-flex justify-content-between align-items-center">' +
                    '<div><strong>' + n.number + '</strong>' +
                    (n.friendlyName ? ' <span class="text-muted">(' + n.friendlyName + ')</span>' : '') +
                    '<br><small class="text-muted">Assigned to: ' + (n.assignedToUserName || n.assignedToUserId || 'Unknown') + '</small>' +
                    '<br><span class="badge bg-secondary me-1">' + (typeNames[n.numberType] || '') + '</span>' +
                    '<span class="badge bg-info">' + (capNames[n.capabilities] || 'SMS') + '</span></div>' +
                    (canAssign ? '<button class="btn btn-sm btn-outline-danger" onclick="unassignNumber(' + n.id + ')"><i class="bi bi-person-dash"></i> Unassign</button>' : '') +
                    '</div>'
                ).join('') + '</div>';
            })
            .catch(() => { document.getElementById('assignedLoading').innerHTML = '<p class="text-danger">Failed to load</p>'; });
        }

        function loadUsers() {
            fetch('/PhoneNumbers/GetUsers')
                .then(r => r.json())
                .then(result => {
                    var select = document.getElementById('assignUserId');
                    select.innerHTML = '<option value="">Select a user</option>';
                    var users = [];
                    if (result.data) {
                        if (Array.isArray(result.data)) users = result.data;
                        else if (result.data.items) users = result.data.items;
                    }
                    users.forEach(u => {
                        var opt = document.createElement('option');
                        opt.value = u.id;
                        opt.textContent = (u.firstName || '') + ' ' + (u.lastName || '') + ' (' + (u.email || '') + ')';
                        select.appendChild(opt);
                    });
                });
        }

        function showAssignModal(id, number) {
            document.getElementById('assignNumberId').value = id;
            document.getElementById('assignNumberDisplay').textContent = number;
            new bootstrap.Modal(document.getElementById('assignModal')).show();
        }

        function confirmAssign() {
            var id = document.getElementById('assignNumberId').value;
            var userId = document.getElementById('assignUserId').value;
            if (!userId) { showNotification('Please select a user', 'error'); return; }

            fetch('/PhoneNumbers/AssignNumber?id=' + id, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId: userId })
            })
            .then(r => r.json())
            .then(result => {
                if (result.success) {
                    showNotification('Number assigned!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('assignModal')).hide();
                    loadAvailable();
                    loadAssigned();
                } else {
                    showNotification(result.message || 'Failed to assign', 'error');
                }
            });
        }

        function unassignNumber(id) {
            if (!confirm('Unassign this number?')) return;
            fetch('/PhoneNumbers/UnassignNumber?id=' + id, { method: 'POST' })
                .then(r => r.json())
                .then(result => {
                    if (result.success) {
                        showNotification('Number unassigned!', 'success');
                        loadAvailable();
                        loadAssigned();
                    } else {
                        showNotification(result.message || 'Failed to unassign', 'error');
                    }
                });
        }
    </script>
}
