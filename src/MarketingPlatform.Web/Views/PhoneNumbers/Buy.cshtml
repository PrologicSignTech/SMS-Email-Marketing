@{
    ViewData["Title"] = "Buy Phone Number";
    Layout = "_LayoutAuthenticated";
    var buyRoles = User.FindAll(System.Security.Claims.ClaimTypes.Role).Select(c => c.Value).ToList();
    var isSuperAdmin = buyRoles.Contains("SuperAdmin");
    var isAdminOrSuper = buyRoles.Contains("Admin") || isSuperAdmin;
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-cart-plus"></i> Buy Phone Number</h2>
        <a href="@Url.Action("Index")" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> Back to Numbers</a>
    </div>

    <!-- Search Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-white">
            <h5 class="mb-0"><i class="bi bi-search me-2"></i>Search Available Numbers</h5>
        </div>
        <div class="card-body">
            <form id="searchForm" onsubmit="searchNumbers(event)">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Country</label>
                        <select class="form-select" id="searchCountry">
                            <option value="US">United States (+1)</option>
                            <option value="CA">Canada (+1)</option>
                            <option value="GB">United Kingdom (+44)</option>
                            <option value="AU">Australia (+61)</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Number Type</label>
                        <select class="form-select" id="searchType">
                            <option value="">Any</option>
                            <option value="0">Local</option>
                            <option value="1">Toll-Free</option>
                            <option value="2">Short Code</option>
                            <option value="3">Mobile</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Capabilities</label>
                        <select class="form-select" id="searchCapabilities">
                            <option value="">Any</option>
                            <option value="0">SMS Only</option>
                            <option value="1">MMS Only</option>
                            <option value="2">SMS + MMS</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Contains (digits/pattern)</label>
                        <input type="text" class="form-control" id="searchContains" placeholder="e.g. 555, 800">
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100" id="searchBtn">
                            <i class="bi bi-search me-1"></i> Search
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Search Results -->
    <div class="row">
        <!-- Database Available Numbers (unassigned in our system) -->
        <div class="@(isSuperAdmin ? "col-lg-6" : "col-lg-12") mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-database me-2"></i>Available Numbers (In Stock)</h5>
                    <span class="badge bg-primary" id="dbResultCount">0</span>
                </div>
                <div class="card-body p-0">
                    <div id="dbResults" style="max-height: 500px; overflow-y: auto;">
                        <div class="text-center text-muted py-5">
                            <i class="bi bi-search" style="font-size: 2rem;"></i>
                            <p class="mt-2">Search to see available numbers</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        @if (isSuperAdmin)
        {
            <!-- Provider Numbers (from Twilio/Nexmo/Plivo) - SuperAdmin only -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow-sm h-100">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="bi bi-cloud-download me-2"></i>Provider Numbers (New)</h5>
                        <span class="badge bg-success" id="providerResultCount">0</span>
                    </div>
                    <div class="card-body p-0">
                        <div id="providerResults" style="max-height: 500px; overflow-y: auto;">
                            <div class="text-center text-muted py-5">
                                <i class="bi bi-cloud me-1" style="font-size: 2rem;"></i>
                                <p class="mt-2">Search to find new numbers from providers</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>

    @if (!isSuperAdmin && !isAdminOrSuper)
    {
        <!-- Info panel for regular users -->
        <div class="card shadow-sm bg-light">
            <div class="card-body">
                <h6><i class="bi bi-info-circle me-1"></i> Number Types</h6>
                <div class="row">
                    <div class="col-md-6">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2"><strong>Local:</strong> Standard local phone numbers for regional messaging</li>
                            <li class="mb-2"><strong>Toll-Free:</strong> 1-800 style numbers for nationwide campaigns</li>
                        </ul>
                    </div>
                    <div class="col-md-6">
                        <ul class="list-unstyled mb-0">
                            <li class="mb-2"><strong>Short Code:</strong> 5-6 digit numbers for high-volume messaging</li>
                            <li><strong>Mobile:</strong> Mobile numbers for person-to-person messaging</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- Payment Confirmation Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-credit-card me-2"></i>Confirm Purchase</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Number Summary -->
                <div class="card bg-light mb-3">
                    <div class="card-body py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong id="modalNumber" class="fs-5">+1 (555) 123-4567</strong>
                                <br><small class="text-muted" id="modalNumberInfo">Local | SMS + MMS</small>
                            </div>
                            <div class="text-end">
                                <span class="fs-5 fw-bold text-success" id="modalPrice">$1.00/mo</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label">Friendly Name (optional)</label>
                    <input type="text" class="form-control" id="modalFriendlyName" placeholder="e.g. Marketing SMS Line">
                </div>

                <!-- Stripe Card Element -->
                <div class="mb-3">
                    <label class="form-label">Payment Card</label>
                    <div id="card-element" class="form-control" style="padding: 12px; height: auto;"></div>
                    <div id="card-errors" class="text-danger mt-1 small"></div>
                </div>

                <div class="alert alert-info small mb-0">
                    <i class="bi bi-info-circle me-1"></i>
                    You will be charged the monthly rate shown above. The number will be active immediately after purchase.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmPurchaseBtn" onclick="confirmPurchase()">
                    <i class="bi bi-cart-check me-1"></i> Confirm &amp; Pay
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://js.stripe.com/v3/"></script>
    <script>
        let stripe = null;
        let cardElement = null;
        let selectedNumber = null;

        // Initialize Stripe
        document.addEventListener('DOMContentLoaded', function () {
            const stripeKey = window.appConfig?.stripePublishableKey;
            if (stripeKey) {
                stripe = Stripe(stripeKey);
                const elements = stripe.elements();
                cardElement = elements.create('card', {
                    style: {
                        base: { fontSize: '16px', color: '#1a1d2e', '::placeholder': { color: '#8a92a6' } },
                        invalid: { color: '#dc3545' }
                    }
                });
                cardElement.mount('#card-element');
                cardElement.on('change', function (event) {
                    var errEl = document.getElementById('card-errors');
                    errEl.textContent = event.error ? event.error.message : '';
                });
            }
        });

        const isSuperAdmin = @(isSuperAdmin ? "true" : "false");

        function searchNumbers(e) {
            e.preventDefault();
            var btn = document.getElementById('searchBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Searching...';

            var params = {
                country: document.getElementById('searchCountry').value,
                numberType: document.getElementById('searchType').value,
                capabilities: document.getElementById('searchCapabilities').value,
                contains: document.getElementById('searchContains').value.trim()
            };

            // Always search database
            searchDatabaseNumbers(params);

            // Also search providers if SuperAdmin
            if (isSuperAdmin) {
                searchProviderNumbers(params);
            }

            setTimeout(function () {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-search me-1"></i> Search';
            }, 500);
        }

        function searchDatabaseNumbers(params) {
            var qs = '?country=' + encodeURIComponent(params.country);
            if (params.numberType) qs += '&numberType=' + params.numberType;
            if (params.capabilities) qs += '&capabilities=' + params.capabilities;
            if (params.contains) qs += '&contains=' + encodeURIComponent(params.contains);

            var container = document.getElementById('dbResults');
            container.innerHTML = '<div class="text-center py-4"><div class="spinner-border"></div><p class="mt-2 text-muted">Searching available numbers...</p></div>';

            fetch('/PhoneNumbers/SearchAvailableNumbers' + qs)
                .then(function (r) { return r.json(); })
                .then(function (result) {
                    if (result.success && result.data && result.data.length > 0) {
                        document.getElementById('dbResultCount').textContent = result.data.length;
                        var html = '<div class="list-group list-group-flush">';
                        result.data.forEach(function (n) {
                            var typeNames = ['Local', 'Toll-Free', 'Short Code', 'Mobile'];
                            var capNames = ['SMS', 'MMS', 'SMS + MMS'];
                            var typeName = typeNames[n.numberType] || 'Unknown';
                            var capName = capNames[n.capabilities] || 'Unknown';
                            var rate = n.monthlyRate ? ('$' + parseFloat(n.monthlyRate).toFixed(2) + '/mo') : '$1.00/mo';
                            html += '<div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">' +
                                '<div>' +
                                '<strong class="d-block">' + (n.number || n.phoneNumber || '') + '</strong>' +
                                '<small class="text-muted">' + typeName + ' | ' + capName + (n.friendlyName ? ' | ' + n.friendlyName : '') + '</small>' +
                                '</div>' +
                                '<div class="text-end">' +
                                '<span class="badge bg-success me-2">' + rate + '</span>' +
                                '<button class="btn btn-sm btn-primary" onclick=\'selectNumber(' + JSON.stringify({
                                    id: n.id,
                                    number: n.number || n.phoneNumber,
                                    numberType: n.numberType,
                                    capabilities: n.capabilities,
                                    monthlyRate: n.monthlyRate || 1.00,
                                    friendlyName: n.friendlyName || '',
                                    source: "database"
                                }) + ')\'><i class="bi bi-cart-plus"></i> Buy</button>' +
                                '</div></div>';
                        });
                        html += '</div>';
                        container.innerHTML = html;
                    } else {
                        document.getElementById('dbResultCount').textContent = '0';
                        container.innerHTML = '<div class="text-center text-muted py-5"><i class="bi bi-inbox" style="font-size: 2rem;"></i><p class="mt-2">No available numbers found matching your criteria</p></div>';
                    }
                })
                .catch(function () {
                    document.getElementById('dbResultCount').textContent = '0';
                    container.innerHTML = '<div class="text-center text-danger py-4"><i class="bi bi-exclamation-triangle"></i> Failed to search numbers</div>';
                });
        }

        function searchProviderNumbers(params) {
            var qs = '?country=' + encodeURIComponent(params.country);
            if (params.numberType) qs += '&numberType=' + params.numberType;
            if (params.capabilities) qs += '&capabilities=' + params.capabilities;
            if (params.contains) qs += '&contains=' + encodeURIComponent(params.contains);

            var container = document.getElementById('providerResults');
            container.innerHTML = '<div class="text-center py-4"><div class="spinner-border"></div><p class="mt-2 text-muted">Searching provider numbers...</p></div>';

            fetch('/PhoneNumbers/SearchProviderNumbers' + qs)
                .then(function (r) { return r.json(); })
                .then(function (result) {
                    if (result.success && result.data && result.data.length > 0) {
                        document.getElementById('providerResultCount').textContent = result.data.length;
                        var html = '<div class="list-group list-group-flush">';
                        result.data.forEach(function (n) {
                            var typeNames = ['Local', 'Toll-Free', 'Short Code', 'Mobile'];
                            var capNames = ['SMS', 'MMS', 'SMS + MMS'];
                            var typeName = typeNames[n.numberType] || n.type || 'Unknown';
                            var capName = capNames[n.capabilities] || 'Unknown';
                            var rate = n.monthlyRate ? ('$' + parseFloat(n.monthlyRate).toFixed(2) + '/mo') : '$1.00/mo';
                            var providerName = n.providerName || 'Provider';
                            html += '<div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">' +
                                '<div>' +
                                '<strong class="d-block">' + (n.number || n.phoneNumber || '') + '</strong>' +
                                '<small class="text-muted">' + typeName + ' | ' + capName + ' | <span class="badge bg-info text-dark">' + providerName + '</span></small>' +
                                '</div>' +
                                '<div class="text-end">' +
                                '<span class="badge bg-success me-2">' + rate + '</span>' +
                                '<button class="btn btn-sm btn-success" onclick=\'selectNumber(' + JSON.stringify({
                                    number: n.number || n.phoneNumber,
                                    numberType: n.numberType,
                                    capabilities: n.capabilities,
                                    monthlyRate: n.monthlyRate || 1.00,
                                    providerId: n.providerId,
                                    providerName: n.providerName || '',
                                    source: "provider"
                                }) + ')\'><i class="bi bi-cloud-download"></i> Purchase</button>' +
                                '</div></div>';
                        });
                        html += '</div>';
                        container.innerHTML = html;
                    } else {
                        document.getElementById('providerResultCount').textContent = '0';
                        container.innerHTML = '<div class="text-center text-muted py-5"><i class="bi bi-cloud-slash" style="font-size: 2rem;"></i><p class="mt-2">No numbers found from providers</p></div>';
                    }
                })
                .catch(function () {
                    document.getElementById('providerResultCount').textContent = '0';
                    container.innerHTML = '<div class="text-center text-danger py-4"><i class="bi bi-exclamation-triangle"></i> Failed to search provider numbers</div>';
                });
        }

        function selectNumber(numberData) {
            selectedNumber = numberData;
            var typeNames = ['Local', 'Toll-Free', 'Short Code', 'Mobile'];
            var capNames = ['SMS', 'MMS', 'SMS + MMS'];

            document.getElementById('modalNumber').textContent = numberData.number;
            document.getElementById('modalNumberInfo').textContent =
                (typeNames[numberData.numberType] || 'Unknown') + ' | ' +
                (capNames[numberData.capabilities] || 'Unknown') +
                (numberData.providerName ? ' | ' + numberData.providerName : '');
            document.getElementById('modalPrice').textContent = '$' + parseFloat(numberData.monthlyRate || 1).toFixed(2) + '/mo';
            document.getElementById('modalFriendlyName').value = numberData.friendlyName || '';

            var modal = new bootstrap.Modal(document.getElementById('paymentModal'));
            modal.show();
        }

        async function confirmPurchase() {
            if (!selectedNumber) return;

            var btn = document.getElementById('confirmPurchaseBtn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Processing...';

            try {
                // Step 1: Create payment intent if Stripe is available
                var paymentMethodId = null;
                if (stripe && cardElement) {
                    var { paymentMethod, error } = await stripe.createPaymentMethod({
                        type: 'card',
                        card: cardElement
                    });

                    if (error) {
                        document.getElementById('card-errors').textContent = error.message;
                        btn.disabled = false;
                        btn.innerHTML = '<i class="bi bi-cart-check me-1"></i> Confirm & Pay';
                        return;
                    }
                    paymentMethodId = paymentMethod.id;
                }

                // Step 2: Purchase the number via our server
                var purchaseData = {
                    number: selectedNumber.number,
                    friendlyName: document.getElementById('modalFriendlyName').value.trim() || null,
                    numberType: selectedNumber.numberType,
                    capabilities: selectedNumber.capabilities,
                    monthlyRate: selectedNumber.monthlyRate || 1.00,
                    source: selectedNumber.source,
                    sourceNumberId: selectedNumber.id || null,
                    providerId: selectedNumber.providerId || null,
                    paymentMethodId: paymentMethodId
                };

                var resp = await fetch('/PhoneNumbers/PurchaseNumber', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(purchaseData)
                });
                var result = await resp.json();

                if (result.success) {
                    bootstrap.Modal.getInstance(document.getElementById('paymentModal')).hide();
                    showNotification('Number purchased successfully!', 'success');
                    setTimeout(function () { window.location.href = '/PhoneNumbers'; }, 1500);
                } else {
                    showNotification(result.message || 'Failed to purchase number', 'error');
                    btn.disabled = false;
                    btn.innerHTML = '<i class="bi bi-cart-check me-1"></i> Confirm & Pay';
                }
            } catch (err) {
                console.error('Purchase error:', err);
                showNotification('An error occurred during purchase', 'error');
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-cart-check me-1"></i> Confirm & Pay';
            }
        }
    </script>
}
