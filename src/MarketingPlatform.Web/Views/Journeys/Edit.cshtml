@{
    ViewData["Title"] = "Edit Journey";
    Layout = "_LayoutAuthenticated";
    var journeyId = ViewBag.JourneyId;
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-signpost-fill"></i> Edit Journey</h2>
        <a href="@Url.Action("Index", "Journeys")" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Back to Journeys
        </a>
    </div>

    <div class="row">
        <div class="col-md-8">
            <div class="card mb-3">
                <div class="card-header">
                    <h5>Journey Information</h5>
                </div>
                <div class="card-body">
                    <form id="journeyForm">
                        <input type="hidden" id="journeyId" value="@journeyId">
                        <div class="mb-3">
                            <label for="journeyName" class="form-label">Journey Name <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="journeyName" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description</label>
                            <textarea class="form-control" id="description" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="triggerType" class="form-label">Entry Trigger <span class="text-danger">*</span></label>
                            <select class="form-select" id="triggerType" required>
                                <option value="">Select Trigger</option>
                                <option value="ContactAdded">Contact Added to Group</option>
                                <option value="FormSubmission">Form Submission</option>
                                <option value="TagAdded">Tag Added</option>
                                <option value="Manual">Manual Enrollment</option>
                                <option value="Scheduled">Scheduled Start</option>
                                <option value="WebhookEvent">Webhook Event</option>
                            </select>
                        </div>
                        <div class="mb-3" id="contactGroupSection" style="display: none;">
                            <label for="contactGroup" class="form-label">Contact Group</label>
                            <select class="form-select" id="contactGroup">
                                <option value="">Select Group</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="status" id="statusDraft" value="Draft">
                                    <label class="form-check-label" for="statusDraft">Draft</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="status" id="statusActive" value="Active">
                                    <label class="form-check-label" for="statusActive">Active</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input" type="radio" name="status" id="statusPaused" value="Paused">
                                    <label class="form-check-label" for="statusPaused">Paused</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Journey Builder</h5>
                    <small class="text-muted">Drag elements from the sidebar to build your journey</small>
                </div>
                <div class="card-body">
                    <div id="journeyCanvas" style="min-height: 400px; border: 2px dashed #dee2e6; border-radius: 8px; padding: 20px;">
                        <div id="journeySteps">
                            <div class="text-center text-muted" id="emptyState">
                                <i class="bi bi-signpost-2" style="font-size: 3rem;"></i>
                                <p class="mt-2">Click on elements from the sidebar to add steps to your journey</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5>Journey Elements</h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="elementsAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#actionsAccordion">
                                    <i class="bi bi-gear me-2"></i> Actions
                                </button>
                            </h2>
                            <div id="actionsAccordion" class="accordion-collapse collapse show" data-bs-parent="#elementsAccordion">
                                <div class="accordion-body">
                                    <div class="list-group">
                                        <button type="button" class="list-group-item list-group-item-action" data-action="SendEmail">
                                            <i class="bi bi-envelope me-2"></i> Send Email
                                        </button>
                                        <button type="button" class="list-group-item list-group-item-action" data-action="SendSMS">
                                            <i class="bi bi-phone me-2"></i> Send SMS
                                        </button>
                                        <button type="button" class="list-group-item list-group-item-action" data-action="Wait">
                                            <i class="bi bi-clock me-2"></i> Wait/Delay
                                        </button>
                                        <button type="button" class="list-group-item list-group-item-action" data-action="AddTag">
                                            <i class="bi bi-tag me-2"></i> Add Tag
                                        </button>
                                        <button type="button" class="list-group-item list-group-item-action" data-action="RemoveTag">
                                            <i class="bi bi-tag-fill me-2"></i> Remove Tag
                                        </button>
                                        <button type="button" class="list-group-item list-group-item-action" data-action="AddToGroup">
                                            <i class="bi bi-people me-2"></i> Add to Group
                                        </button>
                                        <button type="button" class="list-group-item list-group-item-action" data-action="RemoveFromGroup">
                                            <i class="bi bi-person-dash me-2"></i> Remove from Group
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#conditionsAccordion">
                                    <i class="bi bi-signpost-split me-2"></i> Conditions
                                </button>
                            </h2>
                            <div id="conditionsAccordion" class="accordion-collapse collapse" data-bs-parent="#elementsAccordion">
                                <div class="accordion-body">
                                    <div class="list-group">
                                        <button type="button" class="list-group-item list-group-item-action" data-action="IfElse">
                                            <i class="bi bi-diagram-2 me-2"></i> If/Else Branch
                                        </button>
                                        <button type="button" class="list-group-item list-group-item-action" data-action="CheckTag">
                                            <i class="bi bi-check2-square me-2"></i> Check Tag
                                        </button>
                                        <button type="button" class="list-group-item list-group-item-action" data-action="CheckEmail">
                                            <i class="bi bi-envelope-check me-2"></i> Email Opened?
                                        </button>
                                        <button type="button" class="list-group-item list-group-item-action" data-action="CheckLink">
                                            <i class="bi bi-link-45deg me-2"></i> Link Clicked?
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#exitAccordion">
                                    <i class="bi bi-door-open me-2"></i> Exit Points
                                </button>
                            </h2>
                            <div id="exitAccordion" class="accordion-collapse collapse" data-bs-parent="#elementsAccordion">
                                <div class="accordion-body">
                                    <div class="list-group">
                                        <button type="button" class="list-group-item list-group-item-action" data-action="EndJourney">
                                            <i class="bi bi-flag me-2"></i> End Journey
                                        </button>
                                        <button type="button" class="list-group-item list-group-item-action" data-action="GoalReached">
                                            <i class="bi bi-trophy me-2"></i> Goal Reached
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card mt-3">
                <div class="card-body">
                    <button class="btn btn-primary w-100 mb-2" id="saveJourneyBtn">
                        <i class="bi bi-check-circle"></i> Save Changes
                    </button>
                    <button class="btn btn-outline-secondary w-100" id="previewJourneyBtn">
                        <i class="bi bi-eye"></i> Preview
                    </button>
                </div>
            </div>

            <div class="card mt-3 border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Danger Zone</h5>
                </div>
                <div class="card-body">
                    <button class="btn btn-outline-danger w-100" id="deleteJourneyBtn">
                        <i class="bi bi-trash"></i> Delete Journey
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let journeySteps = [];
        let stepCounter = 0;
        const journeyId = document.getElementById('journeyId').value;

        document.addEventListener('DOMContentLoaded', function() {
            // Add step buttons
            document.querySelectorAll('[data-action]').forEach(function(btn) {
                btn.addEventListener('click', function() {
                    addStep(this.dataset.action, this.textContent.trim());
                });
            });

            // Show/hide contact group based on trigger type
            document.getElementById('triggerType').addEventListener('change', function() {
                const showGroup = this.value === 'ContactAdded' || this.value === 'TagAdded';
                document.getElementById('contactGroupSection').style.display = showGroup ? 'block' : 'none';
            });

            // Save journey
            document.getElementById('saveJourneyBtn').addEventListener('click', saveJourney);

            // Preview journey
            document.getElementById('previewJourneyBtn').addEventListener('click', previewJourney);

            // Delete journey
            document.getElementById('deleteJourneyBtn').addEventListener('click', deleteJourney);

            // Load journey data
            loadJourney();

            // Load contact groups
            loadContactGroups();
        });

        async function loadJourney() {
            try {
                const response = await fetch(`/Journeys/GetJourney?id=${journeyId}`);
                const result = await response.json();

                if (result.success && result.data) {
                    const journey = result.data;

                    document.getElementById('journeyName').value = journey.name || '';
                    document.getElementById('description').value = journey.description || '';
                    document.getElementById('triggerType').value = journey.triggerType || '';

                    // Set status
                    const status = journey.status || 'Draft';
                    const statusRadio = document.querySelector(`input[name="status"][value="${status}"]`);
                    if (statusRadio) statusRadio.checked = true;

                    // Show contact group section if needed
                    if (journey.triggerType === 'ContactAdded' || journey.triggerType === 'TagAdded') {
                        document.getElementById('contactGroupSection').style.display = 'block';
                        if (journey.contactGroupId) {
                            document.getElementById('contactGroup').value = journey.contactGroupId;
                        }
                    }

                    // Load steps
                    if (journey.steps && journey.steps.length > 0) {
                        document.getElementById('emptyState').style.display = 'none';
                        journey.steps.forEach(step => {
                            addStepFromData(step);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading journey:', error);
                showNotification('Failed to load journey data', 'danger');
            }
        }

        async function loadContactGroups() {
            try {
                const response = await fetch('/Contacts/GetGroups');
                const result = await response.json();
                if (result.success && result.data) {
                    const select = document.getElementById('contactGroup');
                    result.data.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.id;
                        option.textContent = escapeHtml(group.name);
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading contact groups:', error);
            }
        }

        function addStepFromData(step) {
            stepCounter++;
            const stepId = `step-${stepCounter}`;

            journeySteps.push({
                id: stepId,
                actionType: step.actionType,
                label: getActionLabel(step.actionType),
                order: stepCounter,
                configuration: step.configuration || {}
            });

            const iconMap = {
                'SendEmail': 'bi-envelope',
                'SendSMS': 'bi-phone',
                'Wait': 'bi-clock',
                'AddTag': 'bi-tag',
                'RemoveTag': 'bi-tag-fill',
                'AddToGroup': 'bi-people',
                'RemoveFromGroup': 'bi-person-dash',
                'IfElse': 'bi-diagram-2',
                'CheckTag': 'bi-check2-square',
                'CheckEmail': 'bi-envelope-check',
                'CheckLink': 'bi-link-45deg',
                'EndJourney': 'bi-flag',
                'GoalReached': 'bi-trophy'
            };
            const icon = iconMap[step.actionType] || 'bi-circle';

            const stepHtml = `
                <div class="card mb-2" id="${stepId}">
                    <div class="card-body py-2 px-3 d-flex align-items-center justify-content-between">
                        <div>
                            <span class="badge bg-primary me-2">${stepCounter}</span>
                            <i class="bi ${icon} me-2"></i>
                            <span>${escapeHtml(getActionLabel(step.actionType))}</span>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeStep('${stepId}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('journeySteps').insertAdjacentHTML('beforeend', stepHtml);
        }

        function getActionLabel(actionType) {
            const labels = {
                'SendEmail': 'Send Email',
                'SendSMS': 'Send SMS',
                'Wait': 'Wait/Delay',
                'AddTag': 'Add Tag',
                'RemoveTag': 'Remove Tag',
                'AddToGroup': 'Add to Group',
                'RemoveFromGroup': 'Remove from Group',
                'IfElse': 'If/Else Branch',
                'CheckTag': 'Check Tag',
                'CheckEmail': 'Email Opened?',
                'CheckLink': 'Link Clicked?',
                'EndJourney': 'End Journey',
                'GoalReached': 'Goal Reached'
            };
            return labels[actionType] || actionType;
        }

        function addStep(actionType, label) {
            stepCounter++;
            const stepId = `step-${stepCounter}`;

            journeySteps.push({
                id: stepId,
                actionType: actionType,
                label: label,
                order: stepCounter
            });

            document.getElementById('emptyState').style.display = 'none';

            const iconMap = {
                'SendEmail': 'bi-envelope',
                'SendSMS': 'bi-phone',
                'Wait': 'bi-clock',
                'AddTag': 'bi-tag',
                'RemoveTag': 'bi-tag-fill',
                'AddToGroup': 'bi-people',
                'RemoveFromGroup': 'bi-person-dash',
                'IfElse': 'bi-diagram-2',
                'CheckTag': 'bi-check2-square',
                'CheckEmail': 'bi-envelope-check',
                'CheckLink': 'bi-link-45deg',
                'EndJourney': 'bi-flag',
                'GoalReached': 'bi-trophy'
            };
            const icon = iconMap[actionType] || 'bi-circle';

            const stepHtml = `
                <div class="card mb-2" id="${stepId}">
                    <div class="card-body py-2 px-3 d-flex align-items-center justify-content-between">
                        <div>
                            <span class="badge bg-primary me-2">${stepCounter}</span>
                            <i class="bi ${icon} me-2"></i>
                            <span>${escapeHtml(label)}</span>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeStep('${stepId}')">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            `;

            document.getElementById('journeySteps').insertAdjacentHTML('beforeend', stepHtml);
        }

        function removeStep(stepId) {
            journeySteps = journeySteps.filter(s => s.id !== stepId);
            document.getElementById(stepId).remove();

            if (journeySteps.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function saveJourney() {
            const name = document.getElementById('journeyName').value;
            const description = document.getElementById('description').value;
            const triggerType = document.getElementById('triggerType').value;
            const contactGroupId = document.getElementById('contactGroup').value;
            const status = document.querySelector('input[name="status"]:checked')?.value || 'Draft';

            if (!name) {
                showNotification('Please enter a journey name', 'warning');
                return;
            }

            if (!triggerType) {
                showNotification('Please select an entry trigger', 'warning');
                return;
            }

            const journeyData = {
                id: parseInt(journeyId),
                name: name,
                description: description,
                triggerType: triggerType,
                contactGroupId: contactGroupId || null,
                status: status,
                steps: journeySteps.map((s, index) => ({
                    actionType: s.actionType,
                    order: index + 1,
                    configuration: s.configuration || {}
                }))
            };

            try {
                const response = await fetch('/Journeys/Update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(journeyData)
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Journey updated successfully!', 'success');
                } else {
                    showNotification(result.message || 'Failed to update journey', 'danger');
                }
            } catch (error) {
                console.error('Error updating journey:', error);
                showNotification('An error occurred while updating the journey', 'danger');
            }
        }

        function previewJourney() {
            const name = document.getElementById('journeyName').value || 'Untitled';
            const trigger = document.getElementById('triggerType').value || 'Not Set';
            let preview = `Journey: ${name}\nTrigger: ${trigger}\n\nSteps:\n`;

            if (journeySteps.length === 0) {
                preview += '(No steps added)';
            } else {
                journeySteps.forEach((step, index) => {
                    preview += `${index + 1}. ${step.label}\n`;
                });
            }

            alert(preview);
        }

        async function deleteJourney() {
            if (!confirm('Are you sure you want to delete this journey? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch(`/Journeys/Delete?id=${journeyId}`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Journey deleted successfully!', 'success');
                    setTimeout(() => {
                        window.location.href = '/Journeys/Index';
                    }, 1000);
                } else {
                    showNotification(result.message || 'Failed to delete journey', 'danger');
                }
            } catch (error) {
                console.error('Error deleting journey:', error);
                showNotification('An error occurred while deleting the journey', 'danger');
            }
        }
    </script>
}
