@{
    ViewData["Title"] = "Testimonials";
    Layout = "_LayoutAuthenticated";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-chat-quote"></i> Testimonials</h2>
        <a href="@Url.Action("Create", "Testimonials")" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add Testimonial
        </a>
    </div>

    <div class="alert alert-info">
        <i class="bi bi-info-circle"></i> Manage customer testimonials displayed on the landing page.
    </div>

    <div class="card">
        <div class="card-body">
            <table id="testimonialsTable" class="table table-striped table-hover" style="width:100%">
                <thead>
                    <tr>
                        <th>Order</th>
                        <th>Author</th>
                        <th>Company</th>
                        <th>Quote</th>
                        <th>Rating</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let testimonialsTable;

        $(document).ready(function() {
            testimonialsTable = $('#testimonialsTable').DataTable({
                processing: true,
                ajax: {
                    url: '/Testimonials/GetTestimonials',
                    type: 'POST',
                    contentType: 'application/json',
                    data: function(d) {
                        return JSON.stringify({ draw: d.draw });
                    },
                    dataSrc: function(json) { return json.data || []; }
                },
                columns: [
                    { data: 'displayOrder' },
                    { data: 'authorName', render: function(data) { return `<strong>${escapeHtml(data || '')}</strong>`; } },
                    { data: 'companyName', render: function(data) { return escapeHtml(data || ''); } },
                    { data: 'quote', render: function(data) { return data ? escapeHtml(data).substring(0, 50) + '...' : ''; } },
                    { data: 'rating', render: function(data) {
                        let stars = '';
                        for(let i = 0; i < (data || 0); i++) stars += '<i class="bi bi-star-fill text-warning"></i>';
                        return stars || '-';
                    }},
                    { data: 'isActive', render: function(data) { return data ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>'; } },
                    {
                        data: 'id',
                        orderable: false,
                        render: function(data) {
                            return `<div class="btn-group btn-group-sm">
                                <a href="/Testimonials/Edit/${data}" class="btn btn-outline-primary"><i class="bi bi-pencil"></i></a>
                                <button class="btn btn-outline-danger" onclick="deleteTestimonial(${data})"><i class="bi bi-trash"></i></button>
                            </div>`;
                        }
                    }
                ],
                order: [[0, 'asc']],
                pageLength: 10,
                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]]
            });
        });

        function deleteTestimonial(id) {
            if (confirm('Delete this testimonial?')) {
                $.ajax({
                    url: `/Testimonials/Delete?id=${id}`,
                    method: 'POST',
                    success: function(response) {
                        if (response.success) {
                            showNotification('Testimonial deleted successfully!', 'success');
                            testimonialsTable.ajax.reload(null, false);
                        } else {
                            showNotification(response.message || 'Failed to delete testimonial', 'danger');
                        }
                    },
                    error: function() {
                        showNotification('An error occurred while deleting', 'danger');
                    }
                });
            }
        }
    </script>
}
