@{
    ViewData["Title"] = "System Users";
    Layout = "_LayoutAuthenticated";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-people"></i> System Users</h2>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
            <i class="bi bi-person-plus"></i> Add User
        </button>
    </div>

    <div class="card">
        <div class="card-body">
            <table id="usersTable" class="table table-striped table-hover" style="width:100%">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Tenant</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-person-plus"></i> Add User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addUserForm">
                    <div class="mb-3">
                        <label class="form-label">First Name</label>
                        <input type="text" class="form-control" id="firstName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Last Name</label>
                        <input type="text" class="form-control" id="lastName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="email" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Role</label>
                        <select class="form-select" id="role">
                            <option value="User">User</option>
                            <option value="Admin">Admin</option>
                            <option value="SuperAdmin">SuperAdmin</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addUser()">Add User</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let usersTable;

        $(document).ready(function() {
            usersTable = $('#usersTable').DataTable({
                processing: true,
                ajax: {
                    url: '/SuperAdmin/GetUsers',
                    type: 'POST',
                    contentType: 'application/json',
                    data: function(d) {
                        return JSON.stringify({ draw: d.draw });
                    },
                    dataSrc: function(json) {
                        return json.data || [];
                    },
                    error: function(xhr, error, thrown) {
                        console.error('Error loading users:', error);
                    }
                },
                columns: [
                    {
                        data: null,
                        render: function(data) {
                            const firstName = data.firstName || '';
                            const lastName = data.lastName || '';
                            return escapeHtml(`${firstName} ${lastName}`.trim() || data.name || 'N/A');
                        }
                    },
                    { data: 'email', render: function(data) { return escapeHtml(data || ''); } },
                    { data: 'tenantName', render: function(data) { return escapeHtml(data || 'N/A'); } },
                    {
                        data: 'role',
                        render: function(data) {
                            const role = data || 'User';
                            let badgeClass = 'bg-secondary';
                            if (role === 'SuperAdmin') badgeClass = 'bg-danger';
                            else if (role === 'Admin') badgeClass = 'bg-warning';
                            else if (role === 'User') badgeClass = 'bg-info';
                            return `<span class="badge ${badgeClass}">${escapeHtml(role)}</span>`;
                        }
                    },
                    {
                        data: 'isActive',
                        render: function(data) {
                            return data !== false
                                ? '<span class="badge bg-success">Active</span>'
                                : '<span class="badge bg-secondary">Inactive</span>';
                        }
                    },
                    {
                        data: 'lastLogin',
                        render: function(data) {
                            if (!data) return 'Never';
                            return new Date(data).toLocaleDateString();
                        }
                    },
                    {
                        data: 'id',
                        orderable: false,
                        render: function(data, type, row) {
                            return `<div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" onclick="editUser('${data}')" title="Edit">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-outline-${row.isActive !== false ? 'warning' : 'success'}"
                                        onclick="toggleUserStatus('${data}', ${row.isActive !== false})"
                                        title="${row.isActive !== false ? 'Disable' : 'Enable'}">
                                    <i class="bi bi-${row.isActive !== false ? 'lock' : 'unlock'}"></i>
                                </button>
                            </div>`;
                        }
                    }
                ],
                order: [[0, 'asc']],
                pageLength: 10,
                lengthMenu: [[10, 25, 50, -1], [10, 25, 50, "All"]]
            });
        });

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function addUser() {
            const userData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                role: document.getElementById('role').value
            };

            $.ajax({
                url: '/SuperAdmin/CreateUser',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(userData),
                success: function(response) {
                    if (response.success) {
                        showNotification('User created successfully!', 'success');
                        $('#addUserModal').modal('hide');
                        document.getElementById('addUserForm').reset();
                        usersTable.ajax.reload(null, false);
                    } else {
                        showNotification(response.message || 'Failed to create user', 'danger');
                    }
                },
                error: function() {
                    showNotification('An error occurred', 'danger');
                }
            });
        }

        function editUser(id) {
            window.location.href = `/SuperAdmin/EditUser/${id}`;
        }

        function toggleUserStatus(id, currentlyActive) {
            const action = currentlyActive ? 'disable' : 'enable';
            if (confirm(`Are you sure you want to ${action} this user?`)) {
                $.ajax({
                    url: `/SuperAdmin/ToggleUserStatus?id=${id}`,
                    method: 'POST',
                    success: function(response) {
                        if (response.success) {
                            showNotification(`User ${action}d successfully!`, 'success');
                            usersTable.ajax.reload(null, false);
                        } else {
                            showNotification(response.message || 'Failed to update user status', 'danger');
                        }
                    },
                    error: function() {
                        showNotification('An error occurred', 'danger');
                    }
                });
            }
        }
    </script>
}
